#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2014       psychedelys
# Copyright (c) 2015-2018  Pieter-Jan Moreels - pieterjan.moreels@gmail.com
# Copyright (c) 2015-2019  Alexandre Dulaunoy - a@foo.be

import argparse
import json
import os
import re
import sys
import urllib.parse
import operator

runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import lib.DatabaseLayer as db

runPath = os.path.dirname(os.path.realpath(__file__))

if len(sys.argv) < 2:
    print("%s <regex/words to search>\ne.g. %s apache http" % sys.argv[0])
    sys.exit(0)

# join words with .+ to build a regex
search = '.+'.join(sys.argv[1:])
reg = re.compile(search, re.IGNORECASE)
print("Searching for CPE2.2 matching /%s/i" % search)

cpes = {}
for cpe in db.getCPE_2_2(search):
    c,version,part,vendor,product,*_ = cpe['cpe_2_2'].split(':')
    out = ':'.join((vendor,product))
    if out in cpes:
        cpes[out] += 1
    else:
        cpes[out] = 1

for cpe, count in sorted(cpes.items(), key=operator.itemgetter(1), reverse=True):
    print("%4d: %s" % (count, cpe))
